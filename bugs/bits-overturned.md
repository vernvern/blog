# 奇怪的bug： 内存卡损坏导致比特翻转

[wiki:由于现代计算机内存芯片的高度集成，单个内存单元的结构已足够小到易于受到宇宙射线和/或阿尔法粒子的影响。由这些现象引发的错误被称为软性错误，这对基于DRAM或SRAM的内存来说可能是个问题。在任何单个内存比特发生软错误的概率非常小。但是，配以现代计算机的庞大内存空间，加之长时间持续运行的如服务器，在已安装内存中发生软错误的概率可能比较显著。](https://zh.m.wikipedia.org/wiki/%E5%86%85%E5%AD%98%E5%88%B7%E6%B4%97)

说出来你可能不信，这种段子般的bug被我遇到了。。。。


## 现象

公司一台跑算法的机器稳定运行很久了，突然最近开始莫名其妙的卡住假死机，重启查询/var/log并没有找到有用的日志。同样，跑算法的代码也没有任何报错，就是突然就卡住了。重装过系统，但是仍然没有解决问题。 另外这台机器所在的交换机的机器有时候会突然全部上不了外网。

## 排查过程

因为网络原因影响比较大，优先排查这个问题，因为只有一个路由、三个交换机，1个ap，连接方式全部检查过了，路由设置也都检查过了，并没有发现什么有用的信息。有一次，机器又假死机了，过了1分钟同事说外网又上不了的时候，有点怀疑这两个问题有关联，就尝试强制关机假死的机器，结果网络立马好了。


这里其实怀疑有网络回环，但是平时使用时，用 `traceroute`并没有经过这台假死的机器。只能怀疑有广播风暴，但没有证据。


网络问题找不到原因，但一顿测试后发现了稳定复现程序卡死的方法：算法程序开启，然后另外开cp命令大量io操作，一段时间后, 硬盘性能急剧下降，程序和cp都会卡住，不过使用`kill -9`命令可以杀掉算法程序，杀不掉 cp 进程。


到这里其实十分怀疑是硬盘问题，经过大量测试后发现，三个硬盘分别开一cp命令一段事件后，某个硬盘性能会急剧下降。 并且由于算法代码在很多机器都在跑，跑了很多个月了，同时代码也没有报错信息，所以没有太怀疑是代码的问题，到这里比较怀疑是硬盘坏了。


发现苗头的契机：由于重装过系统，需要将之前的 docker 镜像拷过来用，在执行docker load 的时候发现md5值变了，加载不上。更加怀疑是硬盘的问题，在某个硬盘上cp某个文件之后，新文件的md5每次都不一样。另一个硬盘不会（其实也会，只是md5不一样是概率性问题，刚好测了这次没触发，导致在怀疑硬盘上绕了半天）


在确定所有硬盘都会出现拷贝文件md5都可能不一样之后，目前掌握的情况有：
- 算法程序会莫名其妙的卡住, 算法程序卡住的时候`ps`、`htop`之类的命令也会卡住，`ssh`也可能会连不上，系统也有一定几率假死。如果把算法程序kill掉，前面的卡住的现象倒是会消失。
- 大量cp也会导致某些命令卡死
- 小文件拷贝不会出现md5不一致的问题，大文件拷贝问题大几率出现

比较在意拷贝文件md5不一致的问题，所以决定优先解决这个问题

使用文件对比命令: `cmp`对比拷贝前后的文件（8GB），发现target file有几个字节改变了，并且都是其中某一位变少同样的值（忘记截图了）

到这里想起在某个地方看过本文最初的段子中的bug，查资料之后发现这种情况会出现在内存条上，但毕竟这个原因太像段子了，不过因为没啥头绪，抱着试一试吧的心态测试内存条

出问题的机器有两条内存条，先单独插一条插一条分别执行cp看看，发现其中一条会出现md5不一致的问题，另一条不会，两条插回去又会出现，到这里可以确定这个问题是内存条引起的了！

另外找了个内存检测工具：**memtest64**，同时插上两条内存条测试, 测试报告显示出现error的address都是上面发现的那条内存的区间内，二次验证了这条内存有问题～



## 结果

目前拔掉有问题的内存，机器正常跑着，还没出现程序卡死的情况，md5不一致的问题是解决了。

目前还有两个疑问需要时间验证:
- 这里不能直接证明机器莫名奇妙卡住是内存的原因引起
- 这里不能直接证明交换机局域网内机器突然上不了外网的问题莫名奇妙卡住是内存的原因引起, 内存损坏导致比特翻转，再导致广播风暴？这个脑洞太大了。。。。

回头来补坑
